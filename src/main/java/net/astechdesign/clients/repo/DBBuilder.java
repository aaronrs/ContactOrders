package net.astechdesign.clients.repo;

import org.apache.commons.dbutils.QueryRunner;

import javax.sql.DataSource;
import java.sql.SQLException;

public class DBBuilder {

    private static String[] TABLE_NAMES = {"PRODUCTS", "CONTACTS", "ORDERS", "TODOS"};

    public static void initialiseDb(DataSource dataSource) {
        QueryRunner queryRunner = new QueryRunner(dataSource);
        try {
            Boolean isInitialised = queryRunner.query("select 1 from dbInit", rs -> {
                rs.next();
                return rs.getBoolean(1);
            });
            if (isInitialised) return;
        } catch (Exception e) {
            System.out.println("No database: initialising ...");
        }
        try {
            buildTables(queryRunner);
            TestContactsRepo.init();
            queryRunner.update("insert into dbInit values('true')");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void buildTables(QueryRunner runner) throws SQLException {
        for (String name : TABLE_NAMES) {
            runner.update("CREATE SEQUENCE " + name + "_SEQ;");
        }
//        String createTable = "CREATE TEXT TABLE";
        String createTable = "CREATE TABLE";
        runner.update(createTable + " products(" +
                "id INT GENERATED BY DEFAULT AS SEQUENCE PRODUCTS_SEQ PRIMARY KEY," +
                "code VARCHAR(25)," +
                "name VARCHAR(100)," +
                "price VARCHAR(8)," +
                "createDate DATE DEFAULT CURRENT_DATE" +
                ")");

        runner.update(createTable + " contacts(" +
                "id INT GENERATED BY DEFAULT AS SEQUENCE CONTACTS_SEQ PRIMARY KEY," +
                "name VARCHAR(75)," +
                "address VARCHAR(150)," +
                "locality VARCHAR(100)," +
                "town VARCHAR(100)," +
                "county VARCHAR(75)," +
                "postcode VARCHAR(10)," +
                "telephone VARCHAR(15)," +
                "active BOOLEAN DEFAULT TRUE NOT NULL," +
                "createDate DATE DEFAULT CURRENT_DATE" +
                ")");

        runner.update(createTable + " orders(" +
                "id INT GENERATED BY DEFAULT AS SEQUENCE ORDERS_SEQ PRIMARY KEY," +
                "contactId INT NOT NULL," +
                "product VARCHAR(200)," +
                "deliveryDate DATE DEFAULT CURRENT_DATE," +
                "amount INT," +
                "createDate DATE DEFAULT CURRENT_DATE" +
                ")");

        runner.update(createTable + " todos(" +
                "id INT GENERATED BY DEFAULT AS SEQUENCE TODOS_SEQ PRIMARY KEY," +
                "contactId INT," +
                "date DATE," +
                "notes VARCHAR(500)," +
                "createDate DATE DEFAULT CURRENT_DATE" +
                ")");

        runner.update(createTable + " dbInit(init BOOLEAN)");

        for (String name : TABLE_NAMES) {
//            runner.update("SET TABLE " + name + " SOURCE \"" + name + "\"");
        }
//        runner.update("SET TABLE dbInit SOURCE \"dbInit\"");
    }
}